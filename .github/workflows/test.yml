name: Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint
    
    - name: Run tests with coverage
      run: npm run test:coverage
    
    - name: Validate test threshold
      run: |
        COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
        echo "Test coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "Coverage is below 80% threshold"
          exit 1
        fi
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: matrix.node-version == '20.x'
      with:
        file: ./coverage/coverage-final.json
        flags: unittests
        name: codecov-umbrella

  milestone-validation:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run milestone validation
      run: |
        echo "Running milestone validation tests..."
        npm run test -- --reporter=json --outputFile=test-results.json
        
        # Check if tests meet 80% threshold
        PASSED=$(cat test-results.json | jq '.numPassedTests')
        TOTAL=$(cat test-results.json | jq '.numTotalTests')
        PASS_RATE=$(echo "scale=2; $PASSED / $TOTAL" | bc)
        
        echo "Test pass rate: $PASS_RATE"
        if (( $(echo "$PASS_RATE < 0.8" | bc -l) )); then
          echo "Tests do not meet 80% pass threshold"
          exit 1
        fi